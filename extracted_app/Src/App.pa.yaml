# ************************************************************************************************
# Warning: YAML source code for Canvas Apps should only be used to review changes made within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
# 
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
# 
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
# ************************************************************************************************
App:
  Properties:
    OnStart: "=// ===============================================\r\n// THEME CONFIGURATION\r\n// ===============================================\r\nSet(\r\n    gblTheme,\r\n    {\r\n        Primary: RGBA(0, 51, 160, 1),\r\n        PrimaryDark: RGBA(0, 40, 130, 1),\r\n        Accent: RGBA(0, 120, 212, 1),\r\n        AccentLight: RGBA(135, 206, 250, 0.2),\r\n        Success: RGBA(16, 124, 16, 1),\r\n        SuccessLight: RGBA(16, 124, 16, 0.1),\r\n        Warning: RGBA(255, 140, 0, 1),\r\n        WarningLight: RGBA(255, 140, 0, 0.1),\r\n        Error: RGBA(168, 0, 0, 1),\r\n        ErrorLight: RGBA(168, 0, 0, 0.1),\r\n        TextPrimary: RGBA(255, 255, 255, 1),\r\n        TextSecondary: RGBA(50, 49, 48, 1),\r\n        TextTertiary: RGBA(117, 117, 117, 1),\r\n        Background: RGBA(248, 249, 250, 1),\r\n        Surface: RGBA(255, 255, 255, 1),\r\n        SurfaceHover: RGBA(245, 245, 245, 1),\r\n        Border: RGBA(209, 213, 219, 1),\r\n        BorderLight: RGBA(229, 231, 235, 1),\r\n        Shadow: RGBA(0, 0, 0, 0.1),\r\n        Overlay: RGBA(0, 0, 0, 0.5)\r\n    }\r\n);\r\n\r\n// Scoring weights and thresholds\r\n    Set(gblScoringWeights, {\r\n        BaseScore: 100,\r\n        Major: 5,\r\n        Minor: 2,\r\n        Observation: 0,\r\n        PhotoRequired: \"Major\"\r\n    });\r\n    \r\n// ===============================================\r\n// RESPONSIVE DESIGN VARIABLES\r\n// ===============================================\r\nSet(\r\n    gblDevice,\r\n    {\r\n        Width: App.Width,\r\n        Height: App.Height,\r\n        IsPhone: App.Width < 768,\r\n        IsTablet: App.Width >= 768 And App.Width < 1024,\r\n        IsDesktop: App.Width >= 1024,\r\n        Padding: If(App.Width < 768, 10, If(App.Width < 1024, 20, 40)),\r\n        HeaderHeight: If(App.Width < 768, 60, 80),\r\n        ButtonHeight: If(App.Width < 768, 44, 60),\r\n        InputHeight: If(App.Width < 768, 44, 60),\r\n        CardRadius: If(App.Width < 768, 6, 10),\r\n        ButtonRadius: If(App.Width < 768, 4, 6),\r\n        FontScale: If(App.Width < 768, 0.85, If(App.Width < 1024, 0.95, 1))\r\n    }\r\n);\r\n\r\n// ===============================================\r\n// ANIMATION SETTINGS\r\n// ===============================================\r\nSet(gblAnimations, {\r\n    FadeIn: 300,\r\n    SlideIn: 400,\r\n    Bounce: 600\r\n});\r\n\r\n// ===============================================\r\n// SCORING SYSTEM CONFIGURATION\r\n// ===============================================\r\nSet(gblScoringWeights, {\r\n    Major: 15,\r\n    Minor: 5,\r\n    Observation: 1,\r\n    BaseScore: 100\r\n});\r\n\r\n// ===============================================\r\n// SCORING CALCULATION FORMULA\r\n// ===============================================\r\nSet(gblAuditScore, \r\n    Max(0, gblScoringWeights.BaseScore - (\r\n        CountRows(Filter(colFindings, Severity = \"Major\")) * gblScoringWeights.Major +\r\n        CountRows(Filter(colFindings, Severity = \"Minor\")) * gblScoringWeights.Minor +\r\n        CountRows(Filter(colFindings, Severity = \"Observation\")) * gblScoringWeights.Observation\r\n    ))\r\n);\r\n\r\n// ===============================================\r\n// CAMERA & PHOTO VARIABLES\r\n// ===============================================\r\nSet(varShowCamera, false);\r\nSet(varResetCamera, false);\r\nSet(varGeneralPhoto, false);\r\nSet(varCurrentPhotoContext, \"\");\r\n\r\n// ===============================================\r\n// LOAD DATA WITH ERROR HANDLING\r\n// ===============================================\r\nConcurrent(\r\n    // Facilities\r\n    IfError(\r\n        ClearCollect(colFacilities,\r\n            Filter(\r\n                FirstN(SortByColumns('Facility Contact List', \"Title\"), 2000),\r\n                !IsBlank('Facility Type') && !IsBlank(Title) && !IsBlank(ID)\r\n            )\r\n        ),\r\n        Notify(\"Warning: Could not load facility list\", NotificationType.Warning);\r\n        ClearCollect(colFacilities, Table())\r\n    ),\r\n    \r\n    // Chemical Products\r\n    IfError(\r\n        ClearCollect(colChemicalProducts, \r\n            FirstN(SortByColumns('Chemical Products List', \"Title\"), 2000)\r\n        ),\r\n        ClearCollect(colChemicalProducts, Table())\r\n    ),\r\n    \r\n    // Grease Traps / Waste Manifests\r\n    IfError(\r\n        ClearCollect(colGreaseTraps, FirstN('Waste Manifest List', 2000)),\r\n        ClearCollect(colGreaseTraps, Table())\r\n    ),\r\n    \r\n    // Tanks\r\n    IfError(\r\n        ClearCollect(colTanks, FirstN('Generators, ASTs & USTs', 2000)),\r\n        ClearCollect(colTanks, Table())\r\n    ),\r\n    \r\n    // Permits\r\n    IfError(\r\n        ClearCollect(colPermits, FirstN('Permits/Licensing/Reporting', 2000)),\r\n        ClearCollect(colPermits, Table())\r\n    )\r\n);\r\n\r\n// ===============================================\r\n// INITIALIZE EMPTY COLLECTIONS\r\n// ===============================================\r\nClear(colFindings);\r\nClear(colFindingPhotos);\r\nClear(colInventories);\r\nClear(colPreviousFindings);\r\nClear(colGeneralPhotos);\r\n\r\n// ===============================================\r\n// GLOBAL AUDIT VARIABLES\r\n// ===============================================\r\nSet(gblAuditType, \"\");\r\nSet(gblSelectedFacility, Blank());\r\nSet(gblCurrentFinding, Blank());\r\nSet(gblCurrentLocation, {Latitude: 0, Longitude: 0, Accuracy: 0, Timestamp: Now()});\r\nSet(gblShowFindingPopup, false);\r\nSet(gblCurrentAuditStep, 1);\r\nSet(gblIsSubmitting, false);\r\nSet(gblReportHTML, \"\");\r\nSet(gblWeatherConditions, \"\");\r\nSet(gblAuditPDF, Blank());\r\nSet(gblAuditScore, 100);\r\nSet(gblPDFReady, false);\r\nSet(gblGeneralObservations, \"\");\r\n\r\n// ===============================================\r\n// DESKTOP REVIEW VARIABLES\r\n// ===============================================\r\nSet(gblDesktopReviewData, Blank());\r\nSet(gblDesktopReviewCompleted, false);\r\n\r\n// ===============================================\r\n// HOUSING ECR VARIABLES\r\n// ===============================================\r\nSet(gblIsHousingECR, false);\r\nSet(gblSelectedHousingSite, Blank());\r\n\r\n// ===============================================\r\n// AST/SPCC VARIABLES\r\n// ===============================================\r\nSet(gblASTInspectionType, \"\");\r\nSet(gblSelectedTanks, []);\r\n// ===============================================\r\n// UI STATE VARIABLES\r\n// ===============================================\r\nSet(gblUIState, {\r\n    SelectedSystemTab: \"Water\",\r\n    SelectedInventoryTab: \"Chemicals\",\r\n    ShowNewChemical: false,\r\n    ShowSPCC: false,\r\n    ShowNPDES: false,\r\n    ShowAirPermit: false,\r\n    ShowTierII: false,\r\n    AnimationComplete: false,\r\n    LoadingMessage: \"\",\r\n    CurrentProgress: 0\r\n});\r\n\r\n// ===============================================\r\n// VALIDATION STATE\r\n// ===============================================\r\nSet(gblValidation, {\r\n    FacilityValid: false,\r\n    LocationValid: false,\r\n    WeatherValid: false,\r\n    FindingValid: false,\r\n    SignatureValid: false\r\n});\r\n\r\n// ===============================================\r\n// FINDING CATEGORIES\r\n// ===============================================\r\nSet(gblFindingCategories,\r\n    Table(\r\n        {Category: \"Permits\", Icon: Icon.DocumentWithContent, Color: gblTheme.Primary},\r\n        {Category: \"Storage\", Icon: Icon.PaperClip, Color: gblTheme.Warning},\r\n        {Category: \"Waste\", Icon: Icon.Trash, Color: gblTheme.Error},\r\n        {Category: \"Water\", Icon: Icon.Filter, Color: gblTheme.Accent},\r\n        {Category: \"Air\", Icon: Icon.Cars, Color: gblTheme.PrimaryDark},\r\n        {Category: \"Safety\", Icon: Icon.Warning, Color: gblTheme.Success}\r\n    )\r\n);\r\n\r\n// ===============================================\r\n// QUICK FINDINGS TEMPLATES\r\n// ===============================================\r\nSet(gblQuickFindings,\r\n    Table(\r\n        {Issue: \"Expired permit\", Severity: \"Major\", MajorType: \"Sovereignty\", Category: \"Permits\", Icon: Icon.Warning},\r\n        {Issue: \"Improper storage\", Severity: \"Minor\", MajorType: \"\", Category: \"Storage\", Icon: Icon.Warning},\r\n        {Issue: \"Missing label\", Severity: \"Observation\", MajorType: \"\", Category: \"Storage\", Icon: Icon.Warning},\r\n        {Issue: \"Spill/staining\", Severity: \"Major\", MajorType: \"Health/Environmental\", Category: \"Environmental\", Icon: Icon.Warning},\r\n        {Issue: \"No containment\", Severity: \"Major\", MajorType: \"Health/Environmental\", Category: \"Storage\", Icon: Icon.Warning},\r\n        {Issue: \"Documentation missing\", Severity: \"Minor\", MajorType: \"\", Category: \"Compliance\", Icon: Icon.Warning}\r\n    )\r\n);\r\n\r\n// ===============================================\r\n// AUDIT STAGES\r\n// ===============================================\r\nSet(gblAuditStages,\r\n    Table(\r\n        {Stage: 1, Title: \"Permits\", Icon: Icon.Warning, Description: \"Review permits and compliance\"},\r\n        {Stage: 2, Title: \"Systems\", Icon: Icon.Warning, Description: \"Inspect water and environmental systems\"},\r\n        {Stage: 3, Title: \"Inventories\", Icon: Icon.Warning, Description: \"Document chemicals, wastes, and tanks\"},\r\n        {Stage: 4, Title: \"Conditions\", Icon: Icon.Camera, Description: \"Document site conditions\"},\r\n        {Stage: 5, Title: \"Review\", Icon: Icon.DocumentWithContent, Description: \"Review and finalize findings\"}\r\n    )\r\n);\r\n\r\n// ===============================================\r\n// SCREEN-SPECIFIC VARIABLES\r\n// ===============================================\r\nSet(varSelectedSystemTab, \"Water\");\r\nSet(varSelectedInventoryTab, \"Chemicals\");\r\nSet(varShowSPCC, false);\r\nSet(varShowNPDES, false);\r\nSet(varShowAirPermit, false);\r\nSet(varShowTierII, false);\r\nSet(varFinalScore, 0);\r\nSet(varScoreInterpretation, \"\");\r\nSet(varSubmitError, false);\r\nSet(varErrorMessage, \"\");\r\nSet(varManualChemical, \"\");\r\nSet(varShowAddFinding, false);\r\nSet(varIsMajor, false);\r\nSet(varFixedOnSite, false);\r\n\r\n// ===============================================\r\n// INITIALIZE NEW AUDIT RECORD\r\n// ===============================================\r\nSet(gblNewAuditRecord, Defaults('Audit Reports'));\r\n\r\n// ===============================================\r\n// RESET FLAG\r\n// ===============================================\r\nSet(varResetApp, false);"
    Theme: =PlatinumTheme
