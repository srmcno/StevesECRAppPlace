# ************************************************************************************************
# Warning: YAML source code for Canvas Apps should only be used to review changes made within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
# 
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
# 
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
# ************************************************************************************************
App:
  Properties:
    OnStart: |-
      =// ===============================================
      // THEME CONFIGURATION
      // ===============================================
      Set(
          gblTheme,
          {
              Primary: RGBA(0, 51, 160, 1),
              PrimaryDark: RGBA(0, 40, 130, 1),
              Accent: RGBA(0, 120, 212, 1),
              AccentLight: RGBA(135, 206, 250, 0.2),
              Success: RGBA(16, 124, 16, 1),
              SuccessLight: RGBA(16, 124, 16, 0.1),
              Warning: RGBA(255, 140, 0, 1),
              WarningLight: RGBA(255, 140, 0, 0.1),
              Error: RGBA(168, 0, 0, 1),
              ErrorLight: RGBA(168, 0, 0, 0.1),
              TextPrimary: RGBA(255, 255, 255, 1),
              TextSecondary: RGBA(50, 49, 48, 1),
              TextTertiary: RGBA(117, 117, 117, 1),
              Background: RGBA(248, 249, 250, 1),
              Surface: RGBA(255, 255, 255, 1),
              SurfaceHover: RGBA(245, 245, 245, 1),
              Border: RGBA(209, 213, 219, 1),
              BorderLight: RGBA(229, 231, 235, 1),
              Shadow: RGBA(0, 0, 0, 0.1),
              Overlay: RGBA(0, 0, 0, 0.5)
          }
      );

      // Scoring weights and thresholds
      Set(
          gblScoringWeights,
          {
              BaseScore: 100,
              Major: 15,
              Minor: 5,
              Observation: 1,
              PhotoRequired: "Major"
          }
      );

      // Score interpretation bands
      Set(
          gblScoreBands,
          Table(
              {Min: 90, Label: "Excellent", Description: "Minimal compliance issues", Color: gblTheme.Success},
              {Min: 75, Label: "Satisfactory", Description: "Minor issues to address", Color: gblTheme.Accent},
              {Min: 60, Label: "Needs Attention", Description: "Several compliance issues", Color: gblTheme.Warning},
              {Min: 0, Label: "Critical", Description: "Significant compliance concerns", Color: gblTheme.Error}
          )
      );

      // ===============================================
      // RESPONSIVE DESIGN VARIABLES
      // ===============================================
      Set(
          gblDevice,
          {
              Width: App.Width,
              Height: App.Height,
              IsPhone: App.Width < 768,
              IsTablet: App.Width >= 768 And App.Width < 1024,
              IsDesktop: App.Width >= 1024,
              Padding: If(App.Width < 768, 12, If(App.Width < 1024, 20, 36)),
              HeaderHeight: If(App.Width < 768, 56, If(App.Width < 1024, 72, 88)),
              ButtonHeight: If(App.Width < 768, 64, If(App.Width < 1024, 76, 90)),
              InputHeight: If(App.Width < 768, 48, 60),
              CardRadius: If(App.Width < 768, 6, 10),
              ButtonRadius: If(App.Width < 768, 6, 8),
              FontScale: If(App.Width < 768, 0.9, If(App.Width < 1024, 0.95, 1))
          }
      );

      // ===============================================
      // ANIMATION SETTINGS
      // ===============================================
      Set(
          gblAnimations,
          {
              FadeIn: 300,
              SlideIn: 400,
              Bounce: 600
          }
      );

      // ===============================================
      // SCORING CALCULATION FORMULA
      // ===============================================
      Set(
          gblAuditScore,
          With(
              {
                  penaltyTable: AddColumns(
                      colFindings,
                      "Penalty",
                      Switch(
                          Severity,
                          "Major", gblScoringWeights.Major,
                          "Minor", gblScoringWeights.Minor,
                          "Observation", gblScoringWeights.Observation,
                          0
                      )
                  )
              },
              Max(
                  0,
                  gblScoringWeights.BaseScore - Sum(penaltyTable, Penalty)
              )
          )
      );

      // ===============================================
      // CAMERA & PHOTO VARIABLES
      // ===============================================
      Set(varShowCamera, false);
      Set(varResetCamera, false);
      Set(varGeneralPhoto, false);
      Set(varCurrentPhotoContext, "");

      // ===============================================
      // LOAD DATA WITH ERROR HANDLING
      // ===============================================
      Concurrent(
          // Facilities
          IfError(
              ClearCollect(
                  colFacilities,
                  Filter(
                      FirstN(SortByColumns('Facility Contact List', "Title"), 2000),
                      !IsBlank('Facility Type') && !IsBlank(Title) && !IsBlank(ID)
                  )
              ),
              Notify("Warning: Could not load facility list", NotificationType.Warning);
              ClearCollect(colFacilities, Table())
          ),

          // Chemical Products
          IfError(
              ClearCollect(
                  colChemicalProducts,
                  FirstN(SortByColumns('Chemical Products List', "Title"), 2000)
              ),
              ClearCollect(colChemicalProducts, Table())
          ),

          // Grease Traps / Waste Manifests
          IfError(
              ClearCollect(colGreaseTraps, FirstN('Waste Manifest List', 2000)),
              ClearCollect(colGreaseTraps, Table())
          ),

          // Tanks
          IfError(
              ClearCollect(colTanks, FirstN('Generators, ASTs & USTs', 2000)),
              ClearCollect(colTanks, Table())
          ),

          // Permits
          IfError(
              ClearCollect(colPermits, FirstN('Permits/Licensing/Reporting', 2000)),
              ClearCollect(colPermits, Table())
          )
      );

      // ===============================================
      // INITIALIZE EMPTY COLLECTIONS
      // ===============================================
      Clear(colFindings);
      Clear(colFindingPhotos);
      Clear(colInventories);
      Clear(colPreviousFindings);
      Clear(colGeneralPhotos);

      // ===============================================
      // GLOBAL AUDIT VARIABLES
      // ===============================================
      Set(gblAuditType, "");
      Set(gblSelectedFacility, Blank());
      Set(gblCurrentFinding, Blank());
      Set(
          gblCurrentLocation,
          {Latitude: 0, Longitude: 0, Accuracy: 0, Timestamp: Now()}
      );
      Set(gblShowFindingPopup, false);
      Set(gblCurrentAuditStep, 1);
      Set(gblIsSubmitting, false);
      Set(gblReportHTML, "");
      Set(gblWeatherConditions, "");
      Set(gblAuditPDF, Blank());
      Set(gblAuditScore, gblScoringWeights.BaseScore);
      Set(gblPDFReady, false);
      Set(gblGeneralObservations, "");

      // ===============================================
      // UI STATE VARIABLES
      // ===============================================
      Set(
          gblUIState,
          {
              SelectedSystemTab: "Water",
              SelectedInventoryTab: "Chemicals",
              ShowNewChemical: false,
              ShowSPCC: false,
              ShowNPDES: false,
              ShowAirPermit: false,
              ShowTierII: false,
              AnimationComplete: false,
              LoadingMessage: "",
              CurrentProgress: 0
          }
      );

      // ===============================================
      // VALIDATION STATE
      // ===============================================
      Set(
          gblValidation,
          {
              FacilityValid: false,
              LocationValid: false,
              WeatherValid: false,
              FindingValid: false,
              SignatureValid: false
          }
      );

      // ===============================================
      // FINDING CATEGORIES
      // ===============================================
      Set(
          gblFindingCategories,
          Table(
              {Category: "Permits", Icon: Icon.DocumentWithContent, Color: gblTheme.Primary},
              {Category: "Storage", Icon: Icon.PaperClip, Color: gblTheme.Warning},
              {Category: "Waste", Icon: Icon.Trash, Color: gblTheme.Error},
              {Category: "Water", Icon: Icon.Filter, Color: gblTheme.Accent},
              {Category: "Air", Icon: Icon.Cars, Color: gblTheme.PrimaryDark},
              {Category: "Safety", Icon: Icon.Warning, Color: gblTheme.Success}
          )
      );

      // ===============================================
      // QUICK FINDINGS TEMPLATES
      // ===============================================
      Set(
          gblQuickFindings,
          Table(
              {Issue: "Expired permit", Severity: "Major", MajorType: "Sovereignty", Category: "Permits", Icon: Icon.Warning},
              {Issue: "Improper storage", Severity: "Minor", MajorType: "", Category: "Storage", Icon: Icon.Warning},
              {Issue: "Missing label", Severity: "Observation", MajorType: "", Category: "Storage", Icon: Icon.Warning},
              {Issue: "Spill/staining", Severity: "Major", MajorType: "Health/Environmental", Category: "Environmental", Icon: Icon.Warning},
              {Issue: "No containment", Severity: "Major", MajorType: "Health/Environmental", Category: "Storage", Icon: Icon.Warning},
              {Issue: "Documentation missing", Severity: "Minor", MajorType: "", Category: "Compliance", Icon: Icon.Warning}
          )
      );

      // ===============================================
      // AUDIT STAGES
      // ===============================================
      Set(
          gblAuditStages,
          Table(
              {Stage: 1, Title: "Permits", Icon: Icon.Warning, Description: "Review permits and compliance"},
              {Stage: 2, Title: "Systems", Icon: Icon.Warning, Description: "Inspect water and environmental systems"},
              {Stage: 3, Title: "Inventories", Icon: Icon.Warning, Description: "Document chemicals, wastes, and tanks"},
              {Stage: 4, Title: "Conditions", Icon: Icon.Camera, Description: "Document site conditions"},
              {Stage: 5, Title: "Review", Icon: Icon.DocumentWithContent, Description: "Review and finalize findings"}
          )
      );

      // ===============================================
      // SCREEN-SPECIFIC VARIABLES
      // ===============================================
      Set(varSelectedSystemTab, "Water");
      Set(varSelectedInventoryTab, "Chemicals");
      Set(varShowSPCC, false);
      Set(varShowNPDES, false);
      Set(varShowAirPermit, false);
      Set(varShowTierII, false);
      Set(varFinalScore, 0);
      Set(varScoreInterpretation, "");
      Set(varSubmitError, false);
      Set(varErrorMessage, "");
      Set(varManualChemical, "");
      Set(varShowAddFinding, false);
      Set(varIsMajor, false);
      Set(varFixedOnSite, false);

      // ===============================================
      // INITIALIZE NEW AUDIT RECORD
      // ===============================================
      Set(gblNewAuditRecord, Defaults('Audit Reports'));

      // ===============================================
      // RESET FLAG
      // ===============================================
      Set(varResetApp, false);
    Theme: =PlatinumTheme
